<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Examples • bml</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Examples">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bml</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/bml.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Articles</h6></li>
    <li><a class="dropdown-item" href="../articles/installation.html">Installation</a></li>
    <li><a class="dropdown-item" href="../articles/model.html">Model Structure</a></li>
    <li><a class="dropdown-item" href="../articles/examples.html">Examples</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">Frequently Asked Questions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/benrosche/bml/" aria-label="GitHub"><span class="fa fab fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Examples</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/benrosche/bml/blob/HEAD/vignettes/examples.Rmd" class="external-link"><code>vignettes/examples.Rmd</code></a></small>
      <div class="d-none name"><code>examples.Rmd</code></div>
    </div>

    
    
<p>I present three examples to demonstrate how the MMMM can be applied
to analyze spatial, network, and aggregation problems.</p>
<ul>
<li>
<a href="#e1">Example 1: The effect of air quality on home
values</a> (spatial regression)</li>
<li>
<a href="#e2">Example 2: All friends or just your best friend?</a>
(network regression)</li>
<li>
<a href="#e3">Example 3: The effect of political parties’ financial
dependency on the survival coalition governments</a> (aggregation
regression)</li>
</ul>
<div class="section level3">
<h3 id="e1">The effect of air quality on home values<a class="anchor" aria-label="anchor" href="#e1"></a>
</h3>
<p>The R file of this example can be found <a href="https://benrosche.github.io/bml/articles/examples_files/bml-examples.Rmd">here</a>.</p>
<p>This <strong>spatial analysis</strong> example is based on <a href="https://www.sciencedirect.com/science/article/abs/pii/0095069678900062" class="external-link">Harrison
&amp; Rubenfield 1978</a>, who study the effect of air quality on home
values, and a re-analysis by <a href="https://openjournals.wu.ac.at/region/paper_107/107.html" class="external-link">Bivand
2017</a>.</p>
<p>The study employs census tract data from the Boston Standard
Metropolitan Statistical Area in 1970. With tracts containing no housing
units or comprised entirely of institutions excluded, the sample
contains 506 census tracts. Air quality is measured by the concentration
of nitric oxides in the air, which is obtained from a meteorological
model (Transportation and Air Shed Simulation Model). I refer to their
paper for more information on data and operationalization.</p>
<p>Let us load in the data and plot the home values across town:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakubnowosad.com/spData/" class="external-link">spData</a></span><span class="op">)</span>     <span class="co"># spatial datasets</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span>         <span class="co"># read spatial datasets</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/" class="external-link">spdep</a></span><span class="op">)</span>      <span class="co"># create spatial weights</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spatialreg/" class="external-link">spatialreg</a></span><span class="op">)</span> <span class="co"># spatial regression models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://benrosche.github.io/bml">bml</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load spatial data from Boston</span></span>
<span><span class="va">boston</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shapes/boston_tracts.gpkg"</span>, package <span class="op">=</span> <span class="st">"spData"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">CMEDV</span>, <span class="va">NOX</span>, <span class="va">CRIM</span>, <span class="va">RM</span>, <span class="va">DIS</span>, <span class="va">AGE</span>, <span class="va">LSTAT</span>, <span class="va">geom</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">5070</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># use Albers equal-area conic projection</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>tid <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>, lnCMEDV<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">CMEDV</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">NOX</span>, <span class="va">CRIM</span>, <span class="va">RM</span>, <span class="va">DIS</span>, <span class="va">AGE</span>, <span class="va">LSTAT</span><span class="op">)</span>, <span class="va">scale</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">tid</span>, <span class="va">CMEDV</span>, <span class="va">lnCMEDV</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Dependent variable:</span></span>
<span><span class="co"># lnCMEDV = ln(median home value in $1000)</span></span>
<span></span>
<span><span class="co"># Plot median home values across Boston</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">boston</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">CMEDV</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Median home value"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_b</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Explanatory variables (standardized):</span></span>
<span><span class="co"># NOX     = nitric oxides concentration</span></span>
<span><span class="co"># CRIM    = per capita crime</span></span>
<span><span class="co"># RM      = avg. number of rooms per dwelling</span></span>
<span><span class="co"># DIS     = weighted distance to five Boston employment centers</span></span>
<span><span class="co"># AGE     = proportion of units built prior 1940</span></span>
<span><span class="co"># LSTAT   = percentage working-class population</span></span></code></pre></div>
<p>First, we examine three canonical spatial regression models:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Residual spatial effect</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>X</mi><mi>B</mi><mo>+</mo><mi>λ</mi><mi>W</mi><mi>u</mi><mo>+</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">Y = XB + \lambda Wu + \epsilon</annotation></semantics></math>.
This model is called the spatial error model because it incorporates the
residuals of other spatial units into the regression equation of the
focal unit.</li>
<li>
<strong>Exogenous spatial effects</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>X</mi><mi>B</mi><mo>+</mo><mi>W</mi><mi>X</mi><mi>B</mi><mo>+</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">Y = XB + WXB + \epsilon</annotation></semantics></math>.
This model is called the spatial lag-x model because it incorporates the
covariates of other spatial units into the regression equation of the
focal unit.</li>
<li>
<strong>Endogenous spatial effect</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>ρ</mi><mi>W</mi><mi>Y</mi><mo>+</mo><mi>X</mi><mi>B</mi><mo>+</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">Y = \rho WY + XB + \epsilon</annotation></semantics></math>.
This model is called the spatial autoregressive model because it
incorporates the outcomes of other spatial units into the regression
equation of the focal unit.</li>
</ol>
<p>More information on those models and combinations of them can be
found in <a href="https://www.sciencedirect.com/science/article/pii/B9780444595171000039" class="external-link">Gibbons,
Overman &amp; Patacchini 2015</a>.</p>
<p>To specify any of these models, we must construct a <strong>spatial
weight matrix</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>,
which defines the neighborhood structure for each location.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
is an
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">N \times N</annotation></semantics></math>
matrix, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
represents the number of neighborhoods. Each element
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">w_{ij}</annotation></semantics></math>
quantifies the relationship between locations
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
with the convention that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">w_{ii} = 0</annotation></semantics></math>
along the diagonal.</p>
<p>Neighborhood relationships can be defined in two ways:<br>
- <strong>Binary contiguity</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">w_{ij} = 1</annotation></semantics></math>
if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
are neighbors, and 0 otherwise.<br>
- <strong>Distance-based weighting</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">w_{ij}</annotation></semantics></math>
is a continuous function of distance.</p>
<p>Continuous weights are often row-standardized so that the sum of all
weights for a given location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
equals 1.</p>
<p>The R package <code>spatialreg</code> takes the weight matrix as
list:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create row-standardized weight matrix</span></span>
<span><span class="va">boston_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html" class="external-link">as_Spatial</a></span><span class="op">(</span><span class="va">boston</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="va">boston</span><span class="op">$</span><span class="va">tid</span><span class="op">)</span> <span class="co"># from polygon list to neighbor list</span></span>
<span></span>
<span><span class="va">boston_wmat</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html" class="external-link">nb2mat</a></span><span class="op">(</span><span class="va">boston_nb</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># weight matrix</span></span>
<span><span class="va">boston_wlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="va">boston_nb</span>, style <span class="op">=</span> <span class="st">"W"</span><span class="op">)</span> <span class="co"># weight matrix as list</span></span></code></pre></div>
<p>Now let us estimate the three models:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Residual spatial effect (spatial error model):</span></span>
<span><span class="va">mod1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html" class="external-link">errorsarlm</a></span><span class="op">(</span></span>
<span>    <span class="va">lnCMEDV</span> <span class="op">~</span> <span class="va">NOX</span> <span class="op">+</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">RM</span> <span class="op">+</span> <span class="va">DIS</span> <span class="op">+</span> <span class="va">AGE</span>,</span>
<span>    data <span class="op">=</span> <span class="va">boston</span>,</span>
<span>    listw <span class="op">=</span> <span class="va">boston_wlist</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">mod1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Exogenous spatial effect (spatial lag-x model):</span></span>
<span><span class="va">mod2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/SLX.html" class="external-link">lmSLX</a></span><span class="op">(</span></span>
<span>    <span class="va">lnCMEDV</span> <span class="op">~</span> <span class="va">NOX</span> <span class="op">+</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">RM</span> <span class="op">+</span> <span class="va">DIS</span> <span class="op">+</span> <span class="va">AGE</span>,</span>
<span>    data <span class="op">=</span> <span class="va">boston</span>,</span>
<span>    listw <span class="op">=</span> <span class="va">boston_wlist</span>,</span>
<span>    Durbin <span class="op">=</span>  <span class="op">~</span> <span class="va">NOX</span> <span class="op">+</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">RM</span> <span class="op">+</span> <span class="va">DIS</span> <span class="op">+</span> <span class="va">AGE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">mod2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Endogenous spatial effect (spatial autoregressive model):</span></span>
<span><span class="va">mod3</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html" class="external-link">lagsarlm</a></span><span class="op">(</span></span>
<span>    <span class="va">lnCMEDV</span> <span class="op">~</span> <span class="va">NOX</span> <span class="op">+</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">RM</span> <span class="op">+</span> <span class="va">DIS</span> <span class="op">+</span> <span class="va">AGE</span>,</span>
<span>    data <span class="op">=</span> <span class="va">boston</span>,</span>
<span>    listw <span class="op">=</span> <span class="va">boston_wlist</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">mod3</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Results</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. The spatial error model estimates that after conditioning on those five covariates, the residual is still spatially correlated, as $\lambda$=`r round(mod1$lambda,2)`.</span></span>
<span></span>
<span><span class="co"># 2.  The spatial lag-x model estimates an exogenous spatial effect for each of the considered covariates. The effect of air quality of neighboring locations, for instance, is estimated to be $\beta$=`r round(mod2$coefficients['lag.NOX'],2)`. That is, the home values of a given neighborhood increases if the air quality of surrounding neighborhoods decreases.</span></span>
<span></span>
<span><span class="co"># 3.  The spatial autoregessive (SAR) model estimates a endogenous spatial effect of $\rho$=`r round(mod3$rho,2)`. That is, the SAR summarizes the spatial dependency in one coefficient.</span></span></code></pre></div>
<div class="section level4">
<h4 id="the-mmmm-for-spatial-analysis">The MMMM for spatial analysis<a class="anchor" aria-label="anchor" href="#the-mmmm-for-spatial-analysis"></a>
</h4>
<p>Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">y_{i}</annotation></semantics></math>
denote the outcome for location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>.</p>
<p>Using the MMMM, we can model this outcome based on:<br>
(i) the effects of the location’s own features,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mo>⊺</mo></msubsup><mi>β</mi><mo>+</mo><msub><mi>ϵ</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_{i}^{\intercal} \beta + \epsilon_{i}</annotation></semantics></math><br>
(ii) the effects of its neighbors’ features,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mrow><mi>j</mi><mo>∈</mo><mi>n</mi><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo stretchy="false" form="postfix">)</mo></mrow></msub><msub><mi>w</mi><mi>j</mi></msub><mo stretchy="false" form="prefix">(</mo><msubsup><mi>z</mi><mi>j</mi><mo>⊺</mo></msubsup><mi>γ</mi><mo>+</mo><msub><mi>u</mi><mi>j</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\sum_{j \in n(i)} w_{j} (z_{j}^{\intercal} \gamma + u_{j})</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
indexes the neighbors,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">n(i)</annotation></semantics></math>
is the set of neighbors of location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>z</mi><mi>j</mi></msub><annotation encoding="application/x-tex">z_{j}</annotation></semantics></math>
represents the observed features of neighbor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>u</mi><mi>j</mi></msub><annotation encoding="application/x-tex">u_{j}</annotation></semantics></math>
captures the combined influence of unobserved features.</p>
<p>This model closely resembles a combination of the spatial lag and
spatial error models. The key distinction is that the error term for
each location is decomposed into two components: a random effect for its
role as a focal location and a separate random effect for its role as a
neighbor.</p>
<p>Conceptually, the combination of exogenous spatial effects and
spatial error is intuitive, as a location is influenced by its
neighbors’ entire right-hand side of the regression equation. In
contrast, the endogenous spatial effect model is more challenging to
interpret and faces identification issues when both endogenous and
exogenous effects are included (spatial Durbin model).</p>
<p>To estimate a spatial MMMM, the neighbors of each location must be
included in the dataframe as individual rows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Neighbor list to data.frame</span></span>
<span><span class="va">nb2df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">nb</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      tid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nb</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">nb</span>, <span class="va">length</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      tid_nb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">nb</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">boston_df</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">nb2df</span><span class="op">(</span><span class="va">boston_nb</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">tid</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">boston</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tid"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># own features</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span>                         <span class="co"># neighbor features</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">boston</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">CMEDV</span>,<span class="op">-</span><span class="va">lnCMEDV</span>, <span class="op">-</span><span class="va">geom</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename_with</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">.</span>,<span class="st">"_nb"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tid_nb"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">boston_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">tid</span>, <span class="va">tid_nb</span>, <span class="va">NOX</span>, <span class="va">CRIM</span>, <span class="va">NOX_nb</span>, <span class="va">CRIM_nb</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For each tract <code>tid</code>, we have one row for each of its
neighbors <code>tid_nb</code>. These rows contain the covariates of
<code>tid</code>, which remain constant across its neighbors, as well as
the covariates of the neighbors themselves, such as <code>NOX_nb</code>,
<code>CRIM_nb</code>, ….</p>
<p>With this setup, we are now ready to estimate the MMMM:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Spatial random effect:</span></span>
<span><span class="va">mod.bml1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/bml.html">bml</a></span><span class="op">(</span></span>
<span>    <span class="va">lnCMEDV</span> <span class="op">~</span></span>
<span>      <span class="va">NOX</span> <span class="op">+</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">RM</span> <span class="op">+</span> <span class="va">DIS</span> <span class="op">+</span> <span class="va">AGE</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="../reference/mm.html">mm</a></span><span class="op">(</span></span>
<span>        id <span class="op">=</span> <span class="fu"><a href="../reference/id.html">id</a></span><span class="op">(</span><span class="va">tid_nb</span>, <span class="va">tid</span><span class="op">)</span>,</span>
<span>        vars <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>        fn <span class="op">=</span> <span class="fu"><a href="../reference/fn.html">fn</a></span><span class="op">(</span><span class="va">w</span> <span class="op">~</span> <span class="fl">1</span><span class="op">/</span><span class="va">n</span>, c <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        RE <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span>,</span>
<span>    n.iter <span class="op">=</span> <span class="fl">1000</span>, n.burnin <span class="op">=</span> <span class="fl">100</span>, seed <span class="op">=</span> <span class="fl">1</span>, monitor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    data <span class="op">=</span> <span class="va">boston_df</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mod.bml1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod.bml1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Spatial fixed effects + spatial random effect:</span></span>
<span><span class="va">mod.bml2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/bml.html">bml</a></span><span class="op">(</span></span>
<span>    <span class="va">lnCMEDV</span> <span class="op">~</span></span>
<span>      <span class="va">NOX</span> <span class="op">+</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">RM</span> <span class="op">+</span> <span class="va">DIS</span> <span class="op">+</span> <span class="va">AGE</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="../reference/mm.html">mm</a></span><span class="op">(</span></span>
<span>        id <span class="op">=</span> <span class="fu"><a href="../reference/id.html">id</a></span><span class="op">(</span><span class="va">tid_nb</span>, <span class="va">tid</span><span class="op">)</span>,</span>
<span>        vars <span class="op">=</span> <span class="fu"><a href="../reference/vars.html">vars</a></span><span class="op">(</span><span class="va">NOX_nb</span> <span class="op">+</span> <span class="va">CRIM_nb</span> <span class="op">+</span> <span class="va">RM_nb</span> <span class="op">+</span> <span class="va">DIS_nb</span> <span class="op">+</span> <span class="va">AGE_nb</span><span class="op">)</span>,</span>
<span>        fn <span class="op">=</span> <span class="fu"><a href="../reference/fn.html">fn</a></span><span class="op">(</span><span class="va">w</span> <span class="op">~</span> <span class="fl">1</span><span class="op">/</span><span class="va">n</span>, c <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        RE <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span>,</span>
<span>    n.iter <span class="op">=</span> <span class="fl">1000</span>, n.burnin <span class="op">=</span> <span class="fl">100</span>, seed <span class="op">=</span> <span class="fl">1</span>, monitor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    data <span class="op">=</span> <span class="va">boston_df</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mod.bml2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate spatial correlation in the residual</span></span>
<span><span class="va">getLambda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s.mm</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">reg.table</span><span class="op">[</span><span class="st">"sigma.mm"</span>, <span class="st">"coefficients"</span><span class="op">]</span></span>
<span>  <span class="va">s</span>    <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">reg.table</span><span class="op">[</span><span class="st">"sigma"</span>, <span class="st">"coefficients"</span><span class="op">]</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">s.mm</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="op">(</span><span class="va">s.mm</span><span class="op">^</span><span class="fl">2</span><span class="op">+</span><span class="va">s</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mod.bml1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">getLambda</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mod.bml2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">getLambda</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Let’s take a closer look at the<code><a href="../reference/bml.html">bml()</a></code> function by typing
<code><a href="../reference/bml.html">?bml</a></code>.</p>
<p><strong>The formula object</strong></p>
<p>The most important component is the formula object, which in our case
looks like this:
<code>lnCMEDV ~ NOX + CRIM + RM + DIS + AGE + mm(id = id(tid_nb, tid), vars = vars(NOX_nb + CRIM_nb + RM_nb + DIS_nb + AGE_nb), fn = fn(w ~ 1/n, c = TRUE), RE = TRUE)</code></p>
<p>The only difference compared to a <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> formula is the
inclusion of the <code><a href="../reference/mm.html">mm()</a></code> container. Within this container, we
define three sub-containers:<br>
- <code>ids()</code> for the identifiers<br>
- <code>vars = NULL</code> for the covariates being considered,<br>
- <code>fn = fn()</code> to endogenize the weight function. Here,
<code>w ~ 1/n</code> specifies the row-standardized weight.</p>
<p>The combination of the spatial lag and spatial error models can also
be estimated within the spatial regression framework. Let’s estimate it
and compare the results:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Exogenous + residual spatial effect (combination of spatial lag model and spatial error model):</span></span>
<span><span class="va">mod2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html" class="external-link">errorsarlm</a></span><span class="op">(</span></span>
<span>    <span class="va">lnCMEDV</span> <span class="op">~</span> <span class="va">NOX</span> <span class="op">+</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">RM</span> <span class="op">+</span> <span class="va">DIS</span> <span class="op">+</span> <span class="va">AGE</span>,</span>
<span>    data <span class="op">=</span> <span class="va">boston</span>,</span>
<span>    listw <span class="op">=</span> <span class="va">boston_wlist</span>,</span>
<span>    Durbin <span class="op">=</span>  <span class="op">~</span> <span class="va">NOX</span> <span class="op">+</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">RM</span> <span class="op">+</span> <span class="va">DIS</span> <span class="op">+</span> <span class="va">AGE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">mod2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot coefficients next to each other</span></span>
<span><span class="va">coefs</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">mod.bml2</span><span class="op">$</span><span class="va">reg.table</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"MMMM"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html" class="external-link">add_row</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"SLM"</span>, coefficients<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">mod2</span>, level<span class="op">=</span><span class="fl">0.95</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>lb<span class="op">=</span><span class="va">X2.5..</span>, ub<span class="op">=</span><span class="va">X97.5..</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames_to_column</a></span><span class="op">(</span><span class="st">"variable"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        variable<span class="op">=</span></span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">variable</span>, <span class="st">"lag."</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"lag."</span>, <span class="st">""</span>, <span class="va">variable</span><span class="op">)</span>, <span class="st">"_nb"</span><span class="op">)</span>,</span>
<span>            <span class="va">variable</span><span class="op">==</span><span class="st">"(Intercept)"</span> <span class="op">~</span> <span class="st">"X0"</span>,</span>
<span>            <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">variable</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">variable</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X0"</span>, <span class="st">"sigma.mm"</span>, <span class="st">"sigma"</span>, <span class="st">"DIC"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">coefs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">variable</span>, y<span class="op">=</span><span class="va">coefficients</span>, color<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lb</span>, ymax <span class="op">=</span> <span class="va">ub</span><span class="op">)</span>, position<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Coefficients"</span>, x <span class="op">=</span> <span class="st">"Variables"</span>, y<span class="op">=</span><span class="st">""</span>, color<span class="op">=</span><span class="st">"Model"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The estimates are similar but not identical due to differences in the
estimation algorithms (maximum likelihood vs. Bayesian MCMC) and slight
differences in model specifications.</p>
<p>The advantage of using <code>errorsarlm</code> is its faster
estimation and ability to account for endogenous errors. If this model
aligns with your needs, it is generally best to estimate it using the
<code>spatialreg</code> package.</p>
<p><strong>Weight function regression</strong></p>
<p>The MMMM, however, allows the weights to be modeled as a function of
covariates. Instead of assuming a fixed weighting scheme, we can
estimate whether a neighbor’s influence on a location varies based on
specific covariates.</p>
<p>In this example, I hypothesize that a neighbor’s weight in the
overall neighborhood effect depends on the similarity between the
neighbor and the focal location—an idea inspired by social network
theory.</p>
<p>I define <em>similarity</em> as the inverse of the average absolute
difference between a neighbor and the focal location across the six
considered covariates. This measure captures dissimilarity, so I label
the variable <code>DIFF</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Difference between a focal location and its neighbors</span></span>
<span><span class="va">boston_df2</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">boston_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    DIFF<span class="op">=</span><span class="fl">1</span><span class="op">/</span><span class="fl">6</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">NOX</span><span class="op">-</span><span class="va">NOX_nb</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">CRIM</span><span class="op">-</span><span class="va">CRIM_nb</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">RM</span><span class="op">-</span><span class="va">RM_nb</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">DIS</span><span class="op">-</span><span class="va">DIS_nb</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">AGE</span><span class="op">-</span><span class="va">AGE_nb</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">LSTAT</span><span class="op">-</span><span class="va">LSTAT_nb</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The weight function is specified within the <code>fn = fn()</code>
container, allowing for any function that produces bounded weights.
Logical operators such as <em>==, &gt;, &lt;</em> can be used to define
conditions that enable aggregation functions, such as <code>min</code>
or <code>max</code>.</p>
<p>Here, I use the following functional form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>=</mo><mfrac><mn>1</mn><msup><mi>n</mi><mrow><mrow><mi mathvariant="normal">exp</mi><mo>⁡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>−</mi><mi>X</mi><mi>β</mi><mo stretchy="false" form="postfix">)</mo></mrow></msup></mfrac></mrow><annotation encoding="application/x-tex">
w = \frac{1}{n^{\exp(-X\beta)}}
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
is the number of neighbors of location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mi>β</mi></mrow><annotation encoding="application/x-tex">X\beta</annotation></semantics></math>
represents the covariates used to determine the weights.</p>
<p>This formulation has two key advantages:<br>
1. It ensures weights remain bounded between 0 and 1.<br>
2. When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mi>β</mi><mo>=</mo><mn>𝟎</mn></mrow><annotation encoding="application/x-tex">X\beta = \boldsymbol{0}</annotation></semantics></math>,
the weights simplify to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac></mrow><annotation encoding="application/x-tex">w = \frac{1}{n}</annotation></semantics></math>,
which corresponds to the standard row-standardized weights.</p>
<p><strong>The issue of scaling</strong>:</p>
<p>With row-standardized weights, the total sum of weights is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>506</mn></msubsup><msub><mo>∑</mo><mi>j</mi></msub><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>506</mn></msubsup><mn>1</mn><mo>=</mo><mn>506</mn></mrow><annotation encoding="application/x-tex">\sum_{i=1}^{506} \sum_{j} w_{ij} = \sum_{i=1}^{506} 1 = 506</annotation></semantics></math>.</p>
<p>To ensure this overall sum remains unchanged, we need to carefully
specify constraints. Recall that neighbor effects are aggregated as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mrow><mi>j</mi><mo>∈</mo><mi>n</mi><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo stretchy="false" form="postfix">)</mo></mrow></msub><msub><mi>w</mi><mi>j</mi></msub><mo stretchy="false" form="prefix">(</mo><msubsup><mi>z</mi><mi>j</mi><mo>⊺</mo></msubsup><mi>γ</mi><mo>+</mo><msub><mi>u</mi><mi>j</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\sum_{j \in n(i)} w_{j} (z_{j}^{\intercal} \gamma + u_{j})</annotation></semantics></math>.</p>
<p>If the total sum of weights changes, the regression coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>
will be rescaled. To prevent this, we can apply one of two constraints
using the <code>c</code> parameter in <code><a href="../reference/fn.html">fn()</a></code>:</p>
<ul>
<li>
<strong><code>c = TRUE</code></strong>: Ensures that the weights of
a location’s neighbors sum to 1 for each focal location, while allowing
them to vary within each location.<br>
</li>
<li>
<strong><code>c = FALSE</code></strong>: No constraint applied;
weights can vary freely both within and across locations.</li>
</ul>
<p>Both options identify the model but have different substantive
interpretations. Here, we will use weights that sum to 1 for each focal
location while allowing variation within locations
(<code>c = TRUE</code>):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Spatial fixed effects + spatial random effect with "endogenized" weights:</span></span>
<span><span class="va">mod.bml3</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/bml.html">bml</a></span><span class="op">(</span></span>
<span>    <span class="va">lnCMEDV</span> <span class="op">~</span></span>
<span>      <span class="va">NOX</span> <span class="op">+</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">RM</span> <span class="op">+</span> <span class="va">DIS</span> <span class="op">+</span> <span class="va">AGE</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="../reference/mm.html">mm</a></span><span class="op">(</span></span>
<span>        id <span class="op">=</span> <span class="fu"><a href="../reference/id.html">id</a></span><span class="op">(</span><span class="va">tid_nb</span>, <span class="va">tid</span><span class="op">)</span>,</span>
<span>        vars <span class="op">=</span> <span class="fu"><a href="../reference/vars.html">vars</a></span><span class="op">(</span><span class="va">NOX_nb</span> <span class="op">+</span> <span class="va">CRIM_nb</span> <span class="op">+</span> <span class="va">RM_nb</span> <span class="op">+</span> <span class="va">DIS_nb</span> <span class="op">+</span> <span class="va">AGE_nb</span><span class="op">)</span>,</span>
<span>        fn <span class="op">=</span> <span class="fu"><a href="../reference/fn.html">fn</a></span><span class="op">(</span><span class="va">w</span> <span class="op">~</span> <span class="fl">1</span><span class="op">/</span><span class="va">n</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">b1</span><span class="op">*</span><span class="va">DIFF</span><span class="op">)</span><span class="op">)</span>, c <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        RE <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span>,</span>
<span>    priors<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b.w~dnorm(0,1)"</span><span class="op">)</span>, n.iter <span class="op">=</span> <span class="fl">1000</span>, n.burnin <span class="op">=</span> <span class="fl">100</span>, seed<span class="op">=</span><span class="fl">1</span>, monitor <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    data <span class="op">=</span> <span class="va">boston_df2</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mod.bml3</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/monetPlot.html">monetPlot</a></span><span class="op">(</span><span class="va">mod.bml3</span>, parameter<span class="op">=</span><span class="st">"b.w"</span><span class="op">)</span></span></code></pre></div>
<p>We find that the degree of dissimilarity between a location and its
neighbors significantly affects the aggregation weights, with more
similar neighbors exerting greater influence than less similar ones.</p>
<p>In other words, features of neighbors that differ significantly from
the focal location in terms of air quality, crime levels, and other
factors have less impact on home values in the focal neighborhood. This
insight would be impossible to uncover using conventional spatial
regression models!</p>
<p>If we set <code>monitor=T</code>, we can take a look at the weight
estimates:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mod.bml3</span><span class="op">$</span><span class="va">w</span>, sum<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">mod.bml3</span><span class="op">$</span><span class="va">w</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">mod.bml3</span><span class="op">$</span><span class="va">w</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The weights sum to 1 for each focal location but vary across
neighbors of each location.</p>
<p>Ben 2do:</p>
<ul>
<li>Introduce predict() function<br>
</li>
<li>Compare predictive performance</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="e2">Peer Effects in High School Networks: Equal Influence or
Reciprocity-Weighted?<a class="anchor" aria-label="anchor" href="#e2"></a>
</h3>
<p>A widely used peer effect model in economics is the
<strong>linear-in-means model</strong>, which assumes that all peers in
a group exert equal influence on an individual. An alternative
specification allows peer influence to vary based on relationship
characteristics, such as reciprocity or strength of ties. In this
example, I use the MMMM to empirically test which aggregation mechanism
better fits friendship network data.</p>
<p>We use the <code>faux.highschool</code> dataset from the
<code>ergm.count</code> package, which contains friendship ties among
high school students. For this demonstration, we’ll create a simulated
outcome variable representing academic engagement and test whether peer
characteristics have equal effects or whether reciprocated friendships
carry more weight.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://benrosche.github.io/bml">bml</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://statnet.org" class="external-link">statnet</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">faux.mesa.high</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract node attributes</span></span>
<span><span class="va">nodedat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  student_id <span class="op">=</span> <span class="fu">network.vertex.names</span><span class="op">(</span><span class="va">faux.highschool</span><span class="op">)</span>,</span>
<span>  grade <span class="op">=</span> <span class="va">faux.highschool</span> <span class="op">%v%</span> <span class="st">"grade"</span>,</span>
<span>  sex <span class="op">=</span> <span class="va">faux.highschool</span> <span class="op">%v%</span> <span class="st">"sex"</span>,</span>
<span>  race <span class="op">=</span> <span class="va">faux.highschool</span> <span class="op">%v%</span> <span class="st">"race"</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>student_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">student_id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract edge list (friendship ties)</span></span>
<span><span class="va">edgedat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">as.edgelist</span><span class="op">(</span><span class="va">faux.highschool</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">V1</span>, to <span class="op">=</span> <span class="va">V2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">from</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">to</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Identify reciprocated ties (mutual friendships)</span></span>
<span><span class="va">edgedat</span> <span class="op">&lt;-</span> <span class="va">edgedat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    dyad <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">dyad</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    reciprocated <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span> <span class="co"># TRUE if both i-&gt;j and j-&gt;i exist</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">dyad</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate an academic engagement outcome for demonstration</span></span>
<span><span class="co"># In practice, this would be measured empirically</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">nodedat</span> <span class="op">&lt;-</span> <span class="va">nodedat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="co"># Simulated socioeconomic status</span></span>
<span>    engagement <span class="op">=</span> <span class="fl">50</span> <span class="op">+</span> <span class="fl">5</span> <span class="op">*</span> <span class="op">(</span><span class="va">grade</span> <span class="op">-</span> <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">ses</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Create analysis dataset by merging node and edge data</span></span>
<span><span class="va">network_data</span> <span class="op">&lt;-</span> <span class="va">edgedat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">nodedat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">student_id</span>, <span class="va">ses</span>, <span class="va">engagement</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"from"</span> <span class="op">=</span> <span class="st">"student_id"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>ses_from <span class="op">=</span> <span class="va">ses</span>, engagement_from <span class="op">=</span> <span class="va">engagement</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">nodedat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">student_id</span>, <span class="va">grade</span>, <span class="va">sex</span>, <span class="va">race</span>, <span class="va">ses</span>, <span class="va">engagement</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"to"</span> <span class="op">=</span> <span class="st">"student_id"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    ses_to <span class="op">=</span> <span class="va">ses</span>,</span>
<span>    engagement_to <span class="op">=</span> <span class="va">engagement</span>,</span>
<span>    grade_to <span class="op">=</span> <span class="va">grade</span>,</span>
<span>    sex_to <span class="op">=</span> <span class="va">sex</span>,</span>
<span>    race_to <span class="op">=</span> <span class="va">race</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">from</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    n_friends <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    ses_friends_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ses_to</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Model 1: Naive linear-in-means model (OLS)</span></span>
<span><span class="va">mod_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span></span>
<span>  <span class="va">engagement_from</span> <span class="op">~</span> <span class="va">grade_to</span> <span class="op">+</span> <span class="va">sex_to</span> <span class="op">+</span> <span class="va">race_to</span> <span class="op">+</span> <span class="va">ses_from</span> <span class="op">+</span> <span class="va">ses_friends_mean</span>,</span>
<span>  data <span class="op">=</span> <span class="va">network_data</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod_lm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Model 2: MMMM with equal weights (linear-in-means via MM framework)</span></span>
<span><span class="va">mod_equal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bml.html">bml</a></span><span class="op">(</span></span>
<span>  <span class="va">engagement_from</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/mm.html">mm</a></span><span class="op">(</span></span>
<span>      id <span class="op">=</span> <span class="fu"><a href="../reference/id.html">id</a></span><span class="op">(</span><span class="va">to</span>, <span class="va">from</span><span class="op">)</span>,</span>
<span>      vars <span class="op">=</span> <span class="fu"><a href="../reference/vars.html">vars</a></span><span class="op">(</span><span class="va">ses_to</span><span class="op">)</span>,</span>
<span>      fn <span class="op">=</span> <span class="fu"><a href="../reference/fn.html">fn</a></span><span class="op">(</span><span class="va">w</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">n</span>, c <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      RE <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"Gaussian"</span>,</span>
<span>  n.iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  n.burnin <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">network_data</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod_equal</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Model 3: MMMM with reciprocity-weighted aggregation</span></span>
<span><span class="co"># Test whether reciprocated friendships carry more weight</span></span>
<span><span class="va">mod_reciprocity</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bml.html">bml</a></span><span class="op">(</span></span>
<span>  <span class="va">engagement_from</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/mm.html">mm</a></span><span class="op">(</span></span>
<span>      id <span class="op">=</span> <span class="fu"><a href="../reference/id.html">id</a></span><span class="op">(</span><span class="va">to</span>, <span class="va">from</span><span class="op">)</span>,</span>
<span>      vars <span class="op">=</span> <span class="fu"><a href="../reference/vars.html">vars</a></span><span class="op">(</span><span class="va">ses_to</span><span class="op">)</span>,</span>
<span>      fn <span class="op">=</span> <span class="fu"><a href="../reference/fn.html">fn</a></span><span class="op">(</span><span class="va">w</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">n</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">b1</span> <span class="op">*</span> <span class="va">reciprocated</span><span class="op">)</span>, c <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      RE <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"Gaussian"</span>,</span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b.w ~ dnorm(0, 1)"</span><span class="op">)</span>,</span>
<span>  n.iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  n.burnin <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  monitor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  data <span class="op">=</span> <span class="va">network_data</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod_reciprocity</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize the weight function coefficient</span></span>
<span><span class="fu"><a href="../reference/monetPlot.html">monetPlot</a></span><span class="op">(</span><span class="va">mod_reciprocity</span>, parameter <span class="op">=</span> <span class="st">"b.w"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Interpreting the results:</strong></p>
<ul>
<li>If the weight coefficient (<code>b.w</code>) is close to 0,
reciprocity doesn’t affect peer influence—supporting the linear-in-means
model.</li>
<li>If <code>b.w</code> is significantly positive, reciprocated
friendships carry more weight, suggesting that mutual friends have
stronger peer effects.</li>
<li>The MMMM framework allows us to empirically test these competing
mechanisms rather than imposing one a priori.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare model fit using DIC</span></span>
<span><span class="va">dic_equal</span> <span class="op">&lt;-</span> <span class="va">mod_equal</span><span class="op">$</span><span class="va">DIC</span></span>
<span><span class="va">dic_reciprocity</span> <span class="op">&lt;-</span> <span class="va">mod_reciprocity</span><span class="op">$</span><span class="va">DIC</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"DIC (equal weights):"</span>, <span class="va">dic_equal</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"DIC (reciprocity-weighted):"</span>, <span class="va">dic_reciprocity</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Difference:"</span>, <span class="va">dic_equal</span> <span class="op">-</span> <span class="va">dic_reciprocity</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize coefficient comparison</span></span>
<span><span class="va">coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">mod_equal</span><span class="op">$</span><span class="va">reg.table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"ses_to"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Equal weights"</span><span class="op">)</span>,</span>
<span>  <span class="va">mod_reciprocity</span><span class="op">$</span><span class="va">reg.table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"ses_to"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Reciprocity-weighted"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">coefs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">model</span>, y <span class="op">=</span> <span class="va">coefficients</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lb</span>, ymax <span class="op">=</span> <span class="va">ub</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Peer SES Effect on Academic Engagement"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Comparing equal vs. reciprocity-weighted aggregation"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Model"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Coefficient estimate (95% CI)"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This example demonstrates how the MMMM allows researchers to test
substantive theories about aggregation mechanisms in network data,
moving beyond the assumption of equal peer influence.</p>
<p>```</p>
</div>
<div class="section level3">
<h3 id="e3">The effect of political parties’ financial dependency on the
survival coalition governments<a class="anchor" aria-label="anchor" href="#e3"></a>
</h3>
<p>Here, I replicate the example from the paper, examining whether the
survival of coalition governments is influenced by parties’ financial
dependencies and whether this influence varies across coalition
partners. <a href="https://osf.io/preprints/socarxiv/4bafr_v1" class="external-link">Rosche
(2025)</a>.</p>
<p>Tbd</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Benjamin Rosche.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
